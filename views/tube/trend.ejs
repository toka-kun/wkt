<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>わかめtube - 急上昇</title>

  <meta name="description" content="まっしろになってゆく">
  <meta property="og:title" content="わかめtube">
  <meta property="og:description" content="まっしろになってゆく">
  <meta property="og:site_name" content="わかめtube | まっしろになっていく">
  <meta property="og:image" content="https://cdn.glitch.global/5b8b419f-e61e-4533-9e15-5b2805b88d0e/IMG_1111_Original.jpeg">
  <meta name="theme-color" content="#1F2937">
  <link rel="icon" href="https://cdn.glitch.global/5b8b419f-e61e-4533-9e15-5b2805b88d0e/IMG_1111_Original.jpeg">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <style>
    /* jQuery UIのサジェスト候補がTailwindより手前に来るように調整 */
    .ui-autocomplete { z-index: 1000 !important; }
    /* ロード時のチラつき防止 */
    body { background-color: #111827; } 
  </style>
</head>

<body class="bg-gray-900 text-white font-sans antialiased">

  <header class="bg-gray-800 p-4 flex justify-between items-center fixed top-0 left-0 w-full z-50 shadow-md">
      
      <form action="/wkt/s" method="get" class="w-full md:w-1/2 relative flex items-center" id="searchForm">
          <input type="text" name="q" id="searchbox" placeholder="検索" 
                 class="w-full p-2 pr-10 rounded bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white border-none transition-shadow">
          
          <button type="button" id="clearBtn" class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center h-6 w-6 rounded-full hover:bg-gray-600 text-gray-300 text-lg leading-none hidden">
            ×
          </button>
      </form>

      <nav class="hidden md:flex space-x-6 ml-4">
          <a href="/wkt" class="text-gray-300 hover:text-white transition font-medium">ホーム</a>
          <a href="/wkt/cl/history" class="text-gray-300 hover:text-white transition font-medium">再生履歴</a>
          <a href="/wkt/cl/shistory" class="text-gray-300 hover:text-white transition font-medium">検索履歴</a>
      </nav>
      
      <div class="md:hidden ml-2">
        <a href="/wkt" class="text-gray-300 hover:text-white text-sm font-medium">ホーム</a>
      </div>
  </header>
  
  <div class="container mx-auto p-4 pt-24"> <h2 class="text-2xl font-bold mb-6 border-l-4 border-blue-500 pl-3">急上昇</h2>

      <div id="trend-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          </div>

  </div>

  <script>
  /* -----------------------------------------------
     1. UI制御: 検索ボックスのクリアボタン
  ----------------------------------------------- */
  const searchBox = document.getElementById('searchbox');
  const clearBtn = document.getElementById('clearBtn');

  function toggleClearButton() {
      // 入力がある時だけ「×」を表示
      clearBtn.style.display = searchBox.value ? 'block' : 'none';
  }

  searchBox.addEventListener('input', toggleClearButton);
  
  clearBtn.addEventListener('click', () => {
      searchBox.value = '';
      searchBox.focus();
      toggleClearButton();
  });
  
  // 初期状態チェック
  toggleClearButton();


  /* -----------------------------------------------
     2. データ描画: トレンド動画の生成
  ----------------------------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
      
      // EJS変数の展開 (サーバーから渡されたデータ)
      const trending = <%- JSON.stringify(topVideos.trending) %>;
      const container = document.getElementById("trend-container");

      container.innerHTML = "";

      /**
       * 日時を「◯分前」「◯日前」に変換する関数
       */
      function timeAgo(publishedAt) {
          const now = new Date();
          const published = new Date(publishedAt);
          const diffMs = now - published;
          const diffMin = Math.floor(diffMs / 60000);
          const diffHr = Math.floor(diffMin / 60);
          const diffDay = Math.floor(diffHr / 24);

          if (diffMin < 60) return `${diffMin}分前`;
          if (diffHr < 24) return `${diffHr}時間前`;
          return `${diffDay}日前`;
      }

      /**
       * ISO 8601 Duration (例: PT3M38S) を "3:38" に変換する関数
       */
      function parseDuration(duration) {
          if (!duration) return "";
          // 正規表現で H, M, S を抽出
          const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
          if (!match) return "";
          
          const hours = (match[1] || '').replace('H', '');
          const minutes = (match[2] || '').replace('M', '');
          const seconds = (match[3] || '').replace('S', '');

          // 時間がある場合: H:MM:SS
          if (hours) {
              return `${hours}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
          } 
          // 分のみの場合: M:SS (0分の場合は 0:SS)
          else {
              return `${minutes || '0'}:${seconds.padStart(2, '0')}`;
          }
      }

      // データをループしてHTMLを生成
      trending.forEach(item => {
          const ago = timeAgo(item.publishedAt);
          const durationText = parseDuration(item.duration);
          const viewCount = Number(item.viewCount).toLocaleString();
          
          // チャンネルIDがあればリンク化、なければ #
          const channelUrl = item.channelId ? `/wkt/c/${item.channelId}` : '#';

          // カードHTMLの組み立て
          const html = `
            <div class="result-item bg-gray-800 p-4 rounded-lg shadow hover:bg-gray-700 transition duration-200">
                
                <a href="/wkt/watch/${item.id}" class="block relative group">
                    <img loading="lazy" src="/wkt/back/vi/${item.id}/mqdefault.jpg" alt="${item.title}" class="w-full h-auto rounded aspect-video object-cover">
                    
                    <span class="absolute bottom-1 right-1 bg-black bg-opacity-80 text-white text-xs px-1.5 py-0.5 rounded font-medium">
                        ${durationText}
                    </span>

                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition rounded"></div>
                </a>

                <div class="mt-3 flex items-start space-x-3">
                    
                    <a href="${channelUrl}" class="flex-shrink-0">
                        <img src="${item.channelIcon}" alt="${item.channel}" class="w-9 h-9 rounded-full object-cover bg-gray-600 border border-gray-700">
                    </a>
                    
                    <div class="flex-1 min-w-0">
                        <a href="/wkt/watch/${item.id}">
                            <p class="text-white font-bold text-sm leading-snug line-clamp-2 mb-1 group-hover:text-blue-400 transition">
                                ${item.title}
                            </p>
                        </a>
                        
                        <a href="${channelUrl}" class="text-gray-400 text-xs hover:text-white transition mb-0.5 block truncate">
                            ${item.channel}
                        </a>
                        
                        <p class="text-gray-500 text-xs">
                           ${viewCount} 回視聴 • ${ago}
                        </p>
                    </div>
                </div>
            </div>
          `;
          container.innerHTML += html;
      });
  });

  /* -----------------------------------------------
     3. 機能維持: jQuery Autocomplete (サジェスト)
  ----------------------------------------------- */
  $(function () {
      $('#searchbox').autocomplete({
          source: function (request, response) {
              $.ajax({
                  url: '/wkt/back/suggest',
                  data: { keyword: request.term },
                  success: function (data) {
                      response(data);
                  }
              });
          },
          delay: 200, // サーバー負荷軽減のため少し待機
          select: function (event, ui) {
              $('#searchbox').val(ui.item.value);
              $('#searchForm').submit();
          }
      });
  });
  </script>

</body>
</html>
